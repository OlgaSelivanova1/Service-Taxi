CREATE OR REPLACE PROCEDURE  p_rent_car_RELISE2(p_driverID in number, p_carID in number)
IS
CURSOR search_driver_car
IS 
/*Ищем водителя, который есть в базе*/
/*Водитель не имеет забронированной машины*/
/*Водитель может забронировать одну и ту же машину при условии статус машины 'No'*/
/*В этом случае у него появиться еще одна запись(id машины,ID водителя)в таблице rent_car*/
(select count(*)qnt_aqtvty_rent
from rent_car
where id_driver = (SELECT ID_DRIVER FROM DRIVER WHERE ID_DRIVER = p_driverID)
and date_stop IS NULL
AND id_car =(SELECT ID_CAR
                FROM CAR 
                 WHERE IS_RESERVED = 'Yes'
                    AND ID_CAR = p_carID)
);
v_4_cursor search_driver_car%rowtype; 
v_start_date DATE:= sysdate;
v_status_upd car.is_reserved%type:='Yes';
count_drv_isrsrv NUMBER;
v_car_id NUMBER;
 l_errcode PLS_INTEGER := sqlcode;
BEGIN
OPEN search_driver_car;
LOOP
FETCH search_driver_car INTO v_4_cursor;
EXIT WHEN search_driver_car%NOTFOUND;
END LOOP;
IF v_4_cursor.qnt_aqtvty_rent = 0
THEN
        v_car_id := p_carID;
    IF v_car_id = p_carID AND v_status_upd = 'Yes'
    THEN
        RAISE_APPLICATION_ERROR(-20001, 'Машина занята другим водителем');
    ELSE
    DBMS_OUTPUT.PUT_LINE('Нет активных заказов. Бронирование разрешено');
    END IF;
    INSERT INTO rent_car(id_driver,id_car,date_start)
     VALUES(p_driverID,p_carID,v_start_date);
     /*Меняем статус брони на занятую*/
    UPDATE car
    SET is_reserved = 'Yes'
    WHERE id_car = p_carID;
    COMMIT;
DBMS_OUTPUT.PUT_LINE('Водитель № '||''||p_driverID||' Поздравляем с успешным бронированием автомобиля!'||' '||p_carID);
ELSIF v_4_cursor.qnt_aqtvty_rent >= 1
THEN 
    DBMS_OUTPUT.PUT_LINE('У вас уже имеется бронь:'||' '||v_4_cursor.qnt_aqtvty_rent||' От даты:'||v_start_date);
    DBMS_OUTPUT.PUT_LINE('Чтобы забронировать новую машину, пожалуйста, пройдите процедуру снятия с брони');
    /*DELETE FROM rent_car
    WHERE id_driver = p_driverID
    and date_stop is null
    and time_create <> 
    (select min(time_create) from rent_car where id_driver = p_driverID);*/
    ROLLBACK;
ELSE   
    NULL;
END IF;
CLOSE search_driver_car;

/*Раздел исключений*/
EXCEPTION
WHEN NO_DATA_FOUND THEN
DBMS_OUTPUT.PUT_LINE('Проверьте вводимые значения');
WHEN TOO_MANY_ROWS
THEN
DBMS_OUTPUT.PUT_LINE('За водителем уже числится машина');
WHEN OTHERS 
THEN
DBMS_OUTPUT.PUT_LINE(SQLERRM);
END;
