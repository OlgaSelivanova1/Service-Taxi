CREATE OR REPLACE PACKAGE pkg_salary_drivers
IS
TYPE pipe_row  IS RECORD
            (percent_driver NUMBER
            ,amount_trip NUMBER
            ,amount_gasoline NUMBER
            ,time_create DATE
            ,id_driver NUMBER
            ,full_name varchar2(155)
            );
TYPE tbl_pipe IS TABLE OF pipe_row;
v_tbl tbl_pipe;
v_report_row pipe_row;
FUNCTION func_salary_drivers (p_period IN DATE)
        RETURN tbl_pipe PIPELINED;
END pkg_salary_drivers;
/
CREATE OR REPLACE PACKAGE BODY pkg_salary_drivers
IS
FUNCTION func_salary_drivers (p_period IN DATE)
        RETURN tbl_pipe PIPELINED
IS
CURSOR cur_period_tbl
IS(SELECT DISTINCT(CASE WHEN prcnt_pay IS NULL THEN 0 ELSE prcnt_pay END)percent_driver
        ,sum(sum_order) amount_trip
        ,SUM(COALESCE(sum_pay_gas, 0))amount_gasoline
        ,time_create
        ,id_driver
        ,full_name
FROM(
    SELECT percent_of_payment prcnt_pay
         ,amount_to_paid sum_order
         ,NULL sum_pay_gas
         ,id_pay
         ,TRUNC(payment.time_create, 'MM')time_create
         ,trip.id_driver
         ,(driver.FIRST_NAME||' '||LAST_NAME)full_name
    FROM driver
    JOIN passenger_order_trip trip
    ON driver.id_driver = trip.id_driver
    JOIN payment ON trip.id_order = payment.id_order
    UNION
    SELECT NULL,NULL,amount_to_paid sum_pay_gas
           ,id_pay
            ,TRUNC(payment.time_create, 'MM')time_create
            ,ref_st.id_driver
            ,(driver.FIRST_NAME||' '||LAST_NAME) full_name
    FROM payment,refueling_station ref_st,driver
    WHERE payment.id_pay = ref_st.id_payment AND ref_st.id_driver = driver.id_driver
 )WHERE time_create = p_period AND sum_order IS NOT NULL
GROUP BY prcnt_pay,time_create,id_driver,full_name
);
v_tbl tbl_pipe;
v_report_row pipe_row;
v_salary_mm NUMBER;
BEGIN
OPEN cur_period_tbl;
LOOP
FETCH cur_period_tbl BULK COLLECT INTO v_tbl;
EXIT WHEN v_tbl.COUNT = 0;
    FOR i IN 1..v_tbl.COUNT
LOOP
    v_report_row := NULL;
v_report_row.percent_driver := v_tbl(i).percent_driver;
v_report_row.amount_trip := v_tbl(i).amount_trip;
v_report_row.amount_gasoline := v_tbl(i).amount_gasoline;
v_report_row.time_create := v_tbl(i).time_create;
v_report_row.id_driver := v_tbl(i).id_driver;
v_report_row.full_name := v_tbl(i).full_name;
 PIPE ROW (v_report_row);
IF v_report_row.time_create = p_period
THEN
    v_salary_mm := v_report_row.percent_driver*v_report_row.amount_trip - v_report_row.amount_gasoline;
dbms_output.put_line(v_report_row.full_name||' Зарплата за месяц: '||v_salary_mm);
ELSE 
    NULL;
END IF;
END LOOP;
END LOOP;
dbms_output.put_line('За период: '||p_period);
CLOSE cur_period_tbl;
RETURN;
EXCEPTION
WHEN OTHERS THEN
dbms_output.put_line(SQLERRM||' '||SQLCODE);
END func_salary_drivers;
END pkg_salary_drivers;
/
SELECT * FROM TABLE(pkg_salary_drivers.func_salary_drivers('01.01.2026'));
